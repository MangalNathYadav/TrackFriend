function renderUsers(data) { const now = Date.now(); const users = data || {}; const activeUserIds = new Set(); Object.entries(users).forEach(([username, loc]) => { activeUserIds.add(username); const timeDiff = Math.floor((now - loc.timestamp) / 1000);
const isOffline = timeDiff > OFFLINE_THRESHOLD / 1000; let userNode = userNodes.get(username); // Calculate distance with enhanced precision const distance = currentPosition ? getDistance( currentPosition.coords.latitude, currentPosition.coords.longitude,
loc.latitude, loc.longitude ) : null; // Format distance with appropriate units const distanceDisplay = distance ? distance
< 1 ? `${(distance * 1000).toFixed(0)}m` : `${distance.toFixed(2)}km`; // Determine accuracy level let accuracyClass='accuracy-low' ; if (loc.accuracy <=P RECISION_THRESHOLD_HIGH) { accuracyClass='accuracy-high' ; } else if (loc.accuracy <=P RECISION_THRESHOLD_MEDIUM)
    { accuracyClass='accuracy-medium' ; } if (!userNode) { userNode=d ocument.createElement( 'div'); userNode.className=` user-card ${username===c urrentUsername ? 'current-user' : ''}`; userNodes.set(username, userNode); userListDiv.appendChild(userNode);
    } userNode.className=` user-card ${username===c urrentUsername ? 'current-user' : ''} ${isOffline ? 'offline' : ''}`; userNode.innerHTML=` <div class="user-header">
    <strong>${username}</strong> ${username !== currentUsername && distance ? `
    <span class="distance-badge">
                        <i class="fas fa-location-arrow"></i> ${distanceDisplay}
                    </span>` : ''}
    </div>
    <div class="coords ${accuracyClass}">
        <span class="accuracy-indicator" style="background-color: ${accuracyClass === 'accuracy-high' ? '#28a745' : accuracyClass === 'accuracy-medium' ? '#ffc107' : '#dc3545'}"></span>
        <div class="location-details">
            <div>Lat: ${loc.latitude.toFixed(6)}</div>
            <div>Lng: ${loc.longitude.toFixed(6)}</div>
            ${username !== currentUsername ? `
            <div class="distance-details">
                <i class="fas fa-ruler"></i> Distance: ${distanceDisplay} ${loc.heading ? `<br><i class="fas fa-compass"></i> Bearing: ${loc.heading.toFixed(1)}Â°` : ''}
            </div>` : ''}
        </div>
        <div class="accuracy-info">
            <i class="fas fa-crosshairs"></i> Accuracy: ${loc.accuracy ? loc.accuracy.toFixed(1) + 'm' : 'N/A'} ${loc.speed ? `<br><i class="fas fa-tachometer-alt"></i> Speed: ${(loc.speed * 3.6).toFixed(1)} km/h` : ''}
        </div>
    </div>
    <div class="last-seen">
        <i class="fas fa-clock"></i> ${isOffline ? 'Offline' : timeDiff === 0 ? 'Just now' : `${timeDiff}s ago`}
    </div>
    `; }); // Remove inactive users userNodes.forEach((node, username) => { if (!activeUserIds.has(username)) { userListDiv.removeChild(node); userNodes.delete(username); } }); } // Add these styles to the existing
    <style>
        section: .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .distance-badge {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .location-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 5px 0;
        }
        
        .distance-details {
            grid-column: 1 / -1;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }
        
        .accuracy-info {
            margin-top: 5px;
            font-size: 0.9em;
            color: var(--dark-color);
        }
        
        // Update the getDistance function for more precision:
        function getDistance(lat1, lon1, lat2, lon2) {
            const R=6371; // Earth's radius in kilometers
            const dLat=(lat2 - lat1) * Math.PI / 180;
            const dLon=(lon2 - lon1) * Math.PI / 180;
            const a=Math.sin(dLat/2) * Math.sin(dLat/2)+Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c=2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance=R * c;
            // Return with high precision
            return distance;
        }