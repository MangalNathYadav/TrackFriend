<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Location Tracker</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        #loginDiv,
        #trackerDiv {
            padding: 1rem;
        }
        
        #map {
            flex: 1;
            height: 100%;
            width: 100%;
        }
        
        #loginDiv {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        
        #usernameInput {
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        #startBtn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        
        @media (max-width: 600px) {
            #usernameInput,
            #startBtn {
                width: 90%;
            }
        }
    </style>
</head>

<body>

    <div id="loginDiv">
        <input id="usernameInput" placeholder="Enter your name" />
        <button id="startBtn">Start Tracking</button>
    </div>

    <div id="trackerDiv" style="display: none;">
        <div id="map"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAkkGmA4LVvaxDUoWtMs4vVwmZHBVMCgy0",
            authDomain: "trackfriend-e311f.firebaseapp.com",
            databaseURL: "https://trackfriend-e311f-default-rtdb.firebaseio.com",
            projectId: "trackfriend-e311f",
            storageBucket: "trackfriend-e311f.appspot.com",
            messagingSenderId: "58012498625",
            appId: "1:58012498625:web:e92503aea54af303903240"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const loginDiv = document.getElementById("loginDiv");
        const trackerDiv = document.getElementById("trackerDiv");
        const usernameInput = document.getElementById("usernameInput");
        const startBtn = document.getElementById("startBtn");

        let currentUsername = null;
        let currentMarker = null;
        let userMarkers = {};
        let map = null;

        function updateLocation(position) {
            db.ref("locations/" + currentUsername).set({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                timestamp: Date.now()
            });
        }

        function startTracking() {
            navigator.geolocation.watchPosition(position => {
                updateLocation(position);

                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                if (!currentMarker) {
                    map.setView([lat, lng], 15);
                    currentMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup("You").openPopup();
                } else {
                    currentMarker.setLatLng([lat, lng]);
                }

            }, err => {
                alert("Geolocation error: " + err.message);
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });
        }

        function renderMap() {
            map = L.map('map').setView([20.5937, 78.9629], 5); // Default India

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        function listenToFirebase() {
            db.ref("locations").on("value", snapshot => {
                const data = snapshot.val();
                Object.keys(userMarkers).forEach(user => {
                    if (!data || !data[user]) {
                        map.removeLayer(userMarkers[user]);
                        delete userMarkers[user];
                    }
                });

                for (const user in data) {
                    const {
                        latitude,
                        longitude
                    } = data[user];
                    if (user === currentUsername) continue;

                    if (!userMarkers[user]) {
                        userMarkers[user] = L.marker([latitude, longitude]).addTo(map).bindPopup(user);
                    } else {
                        userMarkers[user].setLatLng([latitude, longitude]);
                    }
                }
            });
        }

        startBtn.onclick = () => {
            const username = usernameInput.value.trim();
            if (!username) return alert("Enter your name!");

            currentUsername = username;
            loginDiv.style.display = "none";
            trackerDiv.style.display = "block";

            renderMap();
            startTracking();
            listenToFirebase();

            // Auto remove on tab close
            window.addEventListener("beforeunload", () => {
                db.ref("locations/" + currentUsername).remove();
            });
        };
    </script>
</body>

</html>