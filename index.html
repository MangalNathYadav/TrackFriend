<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoTracker</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
         :root {
            --primary: #4285F4;
            --success: #34A853;
            --warning: #FBBC05;
            --danger: #EA4335;
            --light: #F8F9FA;
            --dark: #202124;
            --gray: #5F6368;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .login-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #3367D6;
        }
        
        .user-list {
            margin-top: 20px;
        }
        
        .user-card {
            background-color: white;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .user-card.current-user {
            border-left-color: var(--success);
        }
        
        .user-card.offline {
            opacity: 0.6;
        }
        
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .username {
            font-weight: 600;
            font-size: 18px;
        }
        
        .coords {
            font-family: 'Courier New', monospace;
            background-color: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .distance {
            font-size: 14px;
            color: var(--primary);
        }
        
        .last-seen {
            font-size: 12px;
            color: var(--gray);
            text-align: right;
        }
        
        .accuracy {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .accuracy-high {
            background-color: var(--success);
        }
        
        .accuracy-medium {
            background-color: var(--warning);
        }
        
        .accuracy-low {
            background-color: var(--danger);
        }
        
        .status {
            display: none;
            margin-top: 20px;
            padding: 12px;
            border-radius: 4px;
        }
        
        .status.success {
            display: block;
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--success);
        }
        
        .status.error {
            display: block;
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--danger);
        }
        
        .metadata {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray);
            margin-top: 4px;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 16px;
            }
            .container {
                padding: 16px;
            }
            .login-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="login-section">
        <h1>GeoTracker</h1>
        <p>Share your location and see others in real-time</p>
        <div class="login-container">
            <input type="text" id="username-input" placeholder="Enter your username" autocomplete="off">
            <button id="start-tracking-btn">Start Tracking</button>
        </div>
        <div id="login-status" class="status"></div>
    </div>

    <div class="container" id="tracking-section" style="display: none;">
        <h1>Live Tracking</h1>
        <div id="tracking-status" class="status"></div>
        <div id="user-list" class="user-list"></div>
    </div>

    <script>
        // Firebase configuration - Replace with your Firebase project details
        const firebaseConfig = {
            apiKey: "AIzaSyAkkGmA4LVvaxDUoWtMs4vVwmZHBVMCgy0",
            authDomain: "trackfriend-e311f.firebaseapp.com",
            databaseURL: "https://trackfriend-e311f-default-rtdb.firebaseio.com",
            projectId: "trackfriend-e311f",
            storageBucket: "trackfriend-e311f.appspot.com",
            messagingSenderId: "58012498625",
            appId: "1:58012498625:web:e92503aea54af303903240"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const trackingSection = document.getElementById('tracking-section');
        const usernameInput = document.getElementById('username-input');
        const startTrackingBtn = document.getElementById('start-tracking-btn');
        const userListElement = document.getElementById('user-list');
        const loginStatus = document.getElementById('login-status');
        const trackingStatus = document.getElementById('tracking-status');

        // App State
        let currentUsername = null;
        let watchPositionId = null;
        let userNodes = new Map(); // Cache DOM nodes for efficient updates

        // Constants and settings
        const LOCATION_REF = 'locations';
        const UPDATE_THROTTLE = 1000; // Minimum time (ms) between location updates
        const OFFLINE_THRESHOLD = 30000; // Consider user offline after 30 seconds
        const HIGH_ACCURACY_THRESHOLD = 20; // meters
        const MEDIUM_ACCURACY_THRESHOLD = 100; // meters
        const MAX_POSITIONS = 3; // Number of positions to average

        // Performance optimization settings
        let lastUpdateTime = 0;
        let lastPositions = [];
        let pendingUpdate = null;

        // Start tracking button click handler
        startTrackingBtn.addEventListener('click', () => {
            console.log("Start button clicked"); // Debug log
            const username = usernameInput.value.trim();

            if (!username) {
                showStatus(loginStatus, 'Please enter a username', 'error');
                return;
            }

            // Add loading indicator
            showStatus(loginStatus, 'Connecting to Firebase...', 'success');

            // Check if username is already in use
            database.ref(`${LOCATION_REF}/${username}`).once('value')
                .then(snapshot => {
                    console.log("Firebase connection successful"); // Debug log
                    const userData = snapshot.val();

                    if (userData && Date.now() - userData.timestamp < OFFLINE_THRESHOLD) {
                        showStatus(loginStatus, 'This username is already in use', 'error');
                        return;
                    }

                    // Username is available, start tracking
                    currentUsername = username;
                    loginSection.style.display = 'none';
                    trackingSection.style.display = 'block';

                    // Try to get location permission
                    if (navigator.geolocation) {
                        showStatus(trackingStatus, 'Requesting location permission...', 'success');
                        startLocationTracking();

                        // Set up Firebase listener for all users
                        setupLocationListener();
                    } else {
                        showStatus(trackingStatus, 'Geolocation is not supported by your browser', 'error');
                    }
                })
                .catch(error => {
                    console.error('Firebase error:', error); // Detailed error logging
                    showStatus(loginStatus, `Firebase error: ${error.message}. Check console for details.`, 'error');
                });
        });

        // Start location tracking with high precision
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showStatus(trackingStatus, 'Geolocation is not supported by your browser', 'error');
                return;
            }

            // Set up cleanup on page unload
            setupCleanup();

            showStatus(trackingStatus, 'Waiting for location access...', 'success');

            // Start watching position with high accuracy
            try {
                watchPositionId = navigator.geolocation.watchPosition(
                    position => {
                        // First position received successfully
                        showStatus(trackingStatus, 'Location tracking active!', 'success');
                        handlePositionUpdate(position);
                    },
                    error => {
                        console.error('Geolocation error code:', error.code); // Debug error code
                        handlePositionError(error);
                    }, {
                        enableHighAccuracy: true,
                        maximumAge: 0, // Always get fresh position
                        timeout: 10000 // Timeout after 10 seconds
                    }
                );

                console.log("watchPosition started with ID:", watchPositionId); // Debug log
            } catch (e) {
                console.error("Exception starting geolocation:", e); // Capture any exceptions
                showStatus(trackingStatus, `Error: ${e.message}`, 'error');
            }
        }

        // Handle incoming position updates
        function handlePositionUpdate(position) {
            const now = Date.now();

            // Add to position history for averaging
            lastPositions.unshift(position);
            if (lastPositions.length > MAX_POSITIONS) {
                lastPositions.pop();
            }

            // Calculate averaged position
            const avgPosition = averagePositions(lastPositions);

            // Throttle updates to Firebase
            if (now - lastUpdateTime >= UPDATE_THROTTLE) {
                lastUpdateTime = now;

                // Clear any pending update
                if (pendingUpdate) {
                    clearTimeout(pendingUpdate);
                }

                // Update Firebase immediately
                updateLocationInFirebase(avgPosition);
            } else {
                // Schedule update for later if we're within throttle period
                if (!pendingUpdate) {
                    const timeToNextUpdate = UPDATE_THROTTLE - (now - lastUpdateTime);
                    pendingUpdate = setTimeout(() => {
                        updateLocationInFirebase(avgPosition);
                        pendingUpdate = null;
                        lastUpdateTime = Date.now();
                    }, timeToNextUpdate);
                }
            }
        }

        // Calculate an averaged position from multiple readings
        function averagePositions(positions) {
            if (positions.length === 0) return null;

            // Use weighted average, favoring more recent positions
            let totalLat = 0;
            let totalLng = 0;
            let totalAccuracy = 0;
            let totalWeight = 0;

            positions.forEach((pos, index) => {
                // Exponentially decrease weight for older positions
                const weight = Math.pow(0.6, index);
                totalLat += pos.coords.latitude * weight;
                totalLng += pos.coords.longitude * weight;
                totalAccuracy += pos.coords.accuracy * weight;
                totalWeight += weight;
            });

            return {
                coords: {
                    latitude: totalLat / totalWeight,
                    longitude: totalLng / totalWeight,
                    accuracy: totalAccuracy / totalWeight,
                    speed: positions[0].coords.speed || 0,
                    heading: positions[0].coords.heading || null
                },
                timestamp: positions[0].timestamp
            };
        }

        // Update user location in Firebase
        function updateLocationInFirebase(position) {
            if (!currentUsername || !position) return;

            const locationData = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: Date.now(),
                speed: position.coords.speed || 0,
                heading: position.coords.heading || null
            };

            database.ref(`${LOCATION_REF}/${currentUsername}`).update(locationData)
                .catch(error => {
                    console.error('Error updating location:', error);
                    showStatus(trackingStatus, 'Error updating location', 'error');
                });
        }

        // Set up real-time listener for location updates
        function setupLocationListener() {
            database.ref(LOCATION_REF).on('value', snapshot => {
                renderUserList(snapshot.val() || {});
            }, error => {
                console.error('Error getting locations:', error);
                showStatus(trackingStatus, 'Error getting location data', 'error');
            });
        }

        // Render the list of users and their locations
        function renderUserList(usersData) {
            const now = Date.now();
            const activeUserIds = new Set();

            // Get current user's position for distance calculation
            const currentUserData = usersData[currentUsername];

            Object.entries(usersData).forEach(([username, userData]) => {
                        activeUserIds.add(username);

                        const timeDiff = now - userData.timestamp;
                        const isOffline = timeDiff > OFFLINE_THRESHOLD;

                        // Calculate distance from current user
                        let distance = null;
                        if (currentUsername && currentUserData && username !== currentUsername) {
                            distance = calculateDistance(
                                currentUserData.latitude, currentUserData.longitude,
                                userData.latitude, userData.longitude
                            );
                        }

                        // Get accuracy class
                        let accuracyClass = 'accuracy-low';
                        if (userData.accuracy <= HIGH_ACCURACY_THRESHOLD) {
                            accuracyClass = 'accuracy-high';
                        } else if (userData.accuracy <= MEDIUM_ACCURACY_THRESHOLD) {
                            accuracyClass = 'accuracy-medium';
                        }

                        // Get or create DOM node for this user
                        let userNode = userNodes.get(username);

                        if (!userNode) {
                            userNode = document.createElement('div');
                            userNode.className = 'user-card';
                            userListElement.appendChild(userNode);
                            userNodes.set(username, userNode);
                        }

                        // Update user card content
                        userNode.className = `user-card ${username === currentUsername ? 'current-user' : ''} ${isOffline ? 'offline' : ''}`;
                        userNode.innerHTML = `
                    <div class="user-header">
                        <span class="username">${username} ${username === currentUsername ? '(You)' : ''}</span>
                        <span class="last-seen">${formatTimeDiff(timeDiff)}</span>
                    </div>
                    <div class="coords">
                        <span class="accuracy ${accuracyClass}"></span>
                        Lat: ${userData.latitude.toFixed(5)}, Lng: ${userData.longitude.toFixed(5)}
                    </div>
                    <div class="metadata">
                        <span>Accuracy: ${userData.accuracy.toFixed(1)}m</span>
                        ${userData.speed ? `<span>Speed: ${(userData.speed * 3.6).toFixed(1)} km/h</span>` : ''}
                    </div>
                    ${distance !== null ? `<div class="distance">Distance: ${distance.toFixed(2)} km</div>` : ''}
                `;
            });
            
            // Remove users that are no longer in the data
            userNodes.forEach((node, username) => {
                if (!activeUserIds.has(username)) {
                    userListElement.removeChild(node);
                    userNodes.delete(username);
                }
            });
        }
        
        // Calculate the distance between two coordinates in kilometers (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        // Convert degrees to radians
        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        }
        
        // Format time difference for display
        function formatTimeDiff(timeDiff) {
            if (timeDiff < 1000) return 'Just now';
            
            const seconds = Math.floor(timeDiff / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }
        
        // Handle position errors
        function handlePositionError(error) {
            let message;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied. Please allow location access.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out.';
                    break;
                default:
                    message = 'An unknown error occurred.';
            }
            
            showStatus(trackingStatus, message, 'error');
            console.error('Geolocation error:', error);
        }
        
        // Display status messages
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status ${type}`;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
        
        // Set up cleanup when user leaves
        function setupCleanup() {
            const cleanup = () => {
                if (currentUsername) {
                    database.ref(`${LOCATION_REF}/${currentUsername}`).remove()
                        .catch(error => console.error('Error removing location:', error));
                }
                
                if (watchPositionId !== null) {
                    navigator.geolocation.clearWatch(watchPositionId);
                    watchPositionId = null;
                }
            };
            
            // Handle page unload events
            window.addEventListener('beforeunload', cleanup);
            window.addEventListener('pagehide', cleanup);
            
            // Also handle visibility change for mobile browsers
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && currentUsername) {
                    // Mark as offline when tab is hidden
                    database.ref(`${LOCATION_REF}/${currentUsername}`).update({
                        timestamp: Date.now() - OFFLINE_THRESHOLD
                    }).catch(error => console.error('Error updating offline status:', error));
                }
            });
        }
    </script>
</body>

</html>