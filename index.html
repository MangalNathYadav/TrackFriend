<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackFriend - Live Location Sharing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
         :root {
            --primary-color: #3498db;
            /* Blue */
            --secondary-color: #2ecc71;
            /* Green */
            --danger-color: #e74c3c;
            /* Red */
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
            --light-text: #ffffff;
            --border-color: #bdc3c7;
            --hover-primary: #2980b9;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        
        body {
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 12px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            margin: 0;
            font-size: 1.5em;
        }
        
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #map-container {
            flex: 3;
            height: 100%;
            background-color: #dde;
            /* Placeholder while map loads */
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #sidebar {
            flex: 1;
            background-color: var(--light-text);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
        }
        
        #user-info {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #user-info p {
            margin: 8px 0;
            font-size: 0.95em;
        }
        
        #user-info strong {
            color: var(--primary-color);
        }
        
        #user-info #connection-status {
            font-style: italic;
        }
        
        #user-list-container {
            flex-grow: 1;
        }
        
        #user-list-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--dark-text);
            font-size: 1.2em;
            border-bottom: 1px solid var(--light-bg);
            padding-bottom: 5px;
        }
        
        #user-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        #user-list li {
            padding: 12px 8px;
            border-bottom: 1px solid var(--light-bg);
            display: flex;
            flex-direction: column;
            /* Changed for better layout of details */
            font-size: 0.9em;
            transition: background-color 0.2s ease-in-out;
        }
        
        #user-list li:hover {
            background-color: #f9f9f9;
        }
        
        #user-list li:last-child {
            border-bottom: none;
        }
        
        .user-list-item-header {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        .user-name {
            font-weight: 600;
            /* Semibold */
            color: var(--dark-text);
            margin-left: 8px;
            /* Space after status dot */
        }
        
        .user-status {
            min-width: 12px;
            /* Ensure consistent size */
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid var(--light-text);
            /* Contrast with background */
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
        }
        
        .status-active {
            background-color: var(--secondary-color);
        }
        
        .status-stale {
            background-color: var(--danger-color);
        }
        
        .status-self {
            background-color: var(--primary-color);
        }
        
        .user-details {
            font-size: 0.85em;
            color: #7f8c8d;
            padding-left: 22px;
            /* Align with username, after status dot and margin */
            margin-top: 4px;
        }
        
        .user-distance {
            margin-left: auto;
            padding-left: 10px;
            font-weight: 500;
            color: var(--primary-color);
            font-size: 0.9em;
        }
        
        #controls {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            /* Pushes controls to the bottom */
        }
        
        #refresh-button {
            background-color: var(--secondary-color);
            color: var(--light-text);
            border: none;
            padding: 12px 18px;
            text-align: center;
            text-decoration: none;
            display: block;
            /* Make it full width */
            font-size: 1em;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
        }
        
        #refresh-button:hover {
            background-color: #27ae60;
            /* Darker green */
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
        }
        
        #refresh-button:active {
            background-color: #229954;
            /* Even darker green */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* Responsive Design */
        
        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            #map-container {
                height: 55vh;
                /* Adjusted for better balance */
                flex: none;
            }
            #sidebar {
                height: 45vh;
                /* Adjusted for better balance */
                border-left: none;
                border-top: 1px solid var(--border-color);
                flex: none;
                box-shadow: none;
                /* Remove side shadow in column layout */
            }
        }
        /* Leaflet marker customization */
        
        .leaflet-marker-icon .user-marker-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.9em;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            color: var(--dark-text);
            font-weight: 500;
        }
        
        .custom-user-marker div:first-child {
            /* The dot */
            transition: background-color 0.3s ease;
        }
    </style>
</head>

<body>
    <header>
        <h1>TrackFriend - Island Locator</h1>
    </header>
    <main>
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="sidebar">
            <div id="user-info">
                <p>User: <strong id="current-username">N/A</strong></p>
                <p>Status: <span id="connection-status">Connecting...</span></p>
                <p>Latitude: <span id="current-latitude">N/A</span></p>
                <p>Longitude: <span id="current-longitude">N/A</span></p>
                <p>Online Users: <span id="online-users-count">0</span></p>
            </div>
            <div id="user-list-container">
                <h3>Active Users:</h3>
                <ul id="user-list">
                    <!-- User items will be populated here by JavaScript -->
                    <!-- Example: 
                    <li>
                        <span class="user-status status-active"></span>
                        <span class="user-name">Friend1</span>
                        <span class="user-distance"> (2.5 km)</span>
                        <br>
                        <span class="user-details">Last updated: 1 min ago</span>
                    </li> 
                    -->
                </ul>
            </div>
            <div id="distance-tool-container">
                <h4>Calculate Distance Between Users</h4>
                <p>Select two users from the list above by clicking on them.</p>
                <div id="selected-users-display">
                    <p>User 1: <span id="selected-user1-name">None</span></p>
                    <p>User 2: <span id="selected-user2-name">None</span></p>
                </div>
                <button id="calculate-distance-btn" disabled>Calculate Distance</button>
                <p id="distance-result"></p>
            </div>
            <div id="controls">
                <button id="refresh-button">Refresh My Location</button>
            </div>
        </div>
    </main>

    <script>
        // Firebase configuration (use placeholder keys)
        const firebaseConfig = {
            apiKey: "AIzaSyAkkGmA4LVvaxDUoWtMs4vVwmZHBVMCgy0",
            authDomain: "trackfriend-e311f.firebaseapp.com",
            databaseURL: "https://trackfriend-e311f-default-rtdb.firebaseio.com",
            projectId: "trackfriend-e311f",
            storageBucket: "trackfriend-e311f.appspot.com",
            messagingSenderId: "58012498625",
            appId: "1:58012498625:web:e92503aea54af303903240"
        };


        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Global variables
        let currentUser = null;
        let map = null;
        let userMarkers = {}; // To store Leaflet markers for users
        let userPolylines = {}; // To store Leaflet polylines for distances
        const USER_INACTIVITY_THRESHOLD = 60 * 1000; // 1 minute in milliseconds
        const LOCATION_UPDATE_INTERVAL = 1000; // 1 second
        let allUsersData = {}; // To store { username: {latitude, longitude, timestamp, ...} }
        let selectedPairForDistance = []; // Array of two usernames

        // DOM Elements
        const currentUsernameEl = document.getElementById('current-username');
        const connectionStatusEl = document.getElementById('connection-status');
        const onlineUsersCountEl = document.getElementById('online-users-count');
        const userListEl = document.getElementById('user-list');
        const refreshButton = document.getElementById('refresh-button');
        const currentLatitudeEl = document.getElementById('current-latitude');
        const currentLongitudeEl = document.getElementById('current-longitude');
        const calculateDistanceBtn = document.getElementById('calculate-distance-btn');
        const distanceResultEl = document.getElementById('distance-result');
        const selectedUser1NameEl = document.getElementById('selected-user1-name');
        const selectedUser2NameEl = document.getElementById('selected-user2-name');

        // --- UTILITY FUNCTIONS ---

        /**
         * Calculates distance between two lat/lng points in kilometers.
         * Haversine formula.
         */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        /**
         * Formats timestamp to a readable "X units ago" string.
         */
        function timeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.round((now - timestamp) / 1000);

            if (seconds < 5) return "just now";
            if (seconds < 60) return `${seconds}s ago`;

            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;

            const hours = Math.round(minutes / 60);
            if (hours < 24) return `${hours}h ago`;

            const days = Math.round(hours / 24);
            return `${days}d ago`;
        }

        // --- FIREBASE FUNCTIONS ---

        /**
         * Updates the current user's location in Firebase.
         */
        function updateUserLocation(latitude, longitude) {
            if (!currentUser) return;

            const locationData = {
                latitude: latitude,
                longitude: longitude,
                timestamp: firebase.database.ServerValue.TIMESTAMP, // Use server timestamp
                username: currentUser
            };

            const userLocationRef = database.ref(`locations/${currentUser}`);
            userLocationRef.set(locationData)
                .then(() => {
                    // console.log("Location updated for", currentUser);
                    connectionStatusEl.textContent = "Location sent!";
                    setTimeout(() => {
                        if (connectionStatusEl.textContent === "Location sent!") {
                            connectionStatusEl.textContent = "Online";
                        }
                    }, 2000);
                })
                .catch(error => {
                    console.error("Error updating location:", error);
                    connectionStatusEl.textContent = "Error sending location";
                });

            // Set up onDisconnect to remove user data when they close the browser/tab
            userLocationRef.onDisconnect().remove();
        }

        /**
         * Listens for location updates from all users.
         */
        function listenForLocationUpdates() {
            const locationsRef = database.ref('locations');

            locationsRef.on('value', (snapshot) => {
                const locations = snapshot.val();
                allUsersData = locations || {}; // Update global store of all user data
                if (!map || !currentUser) return; // Ensure map and current user are initialized

                const activeUsernames = [];
                if (locations) {
                    Object.keys(locations).forEach(username => {
                        const userData = locations[username];
                        if (username === currentUser) { // Don't process self here, handled by watchPosition
                            activeUsernames.push(username); // Still count self as active
                            updateUserOnMap(username, userData, true); // Update self on map
                            return;
                        }

                        const isStale = (Date.now() - userData.timestamp) > USER_INACTIVITY_THRESHOLD;
                        if (isStale) {
                            // Remove stale user from map and Firebase
                            console.log(`User ${username} is stale. Removing.`);
                            removeUser(username);
                            database.ref(`locations/${username}`).remove(); // Remove from DB
                        } else {
                            activeUsernames.push(username);
                            updateUserOnMap(username, userData, false);
                        }
                    });
                }

                // Remove users from map if they are no longer in Firebase (or became stale and were removed)
                Object.keys(userMarkers).forEach(usernameOnMap => {
                    if (usernameOnMap !== currentUser && !activeUsernames.includes(usernameOnMap)) {
                        removeUser(usernameOnMap);
                    }
                });
                updateUserListGUI(locations);
                onlineUsersCountEl.textContent = activeUsernames.length;
            });
        }

        /**
         * Removes a user from the map and internal tracking.
         */
        function removeUser(username) {
            if (userMarkers[username]) {
                map.removeLayer(userMarkers[username]);
                delete userMarkers[username];
            }
            if (userPolylines[username]) {
                map.removeLayer(userPolylines[username]);
                delete userPolylines[username];
            }
            // console.log(`User ${username} removed from map.`);
            // No need to call updateUserListGUI here, it's called by the main listener
        }


        // --- MAP FUNCTIONS ---

        /**
         * Initializes the Leaflet map.
         */
        function initMap(latitude, longitude) {
            if (map) return; // Already initialized

            map = L.map('map').setView([latitude, longitude], 13); // Initial view centered on user

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add current user's marker immediately
            if (currentUser && latitude && longitude) {
                updateUserOnMap(currentUser, {
                    latitude,
                    longitude,
                    timestamp: Date.now()
                }, true);
            }
        }

        /**
         * Updates or creates a user's marker on the map.
         * Also draws lines and distances to other users.
         */
        function updateUserOnMap(username, userData, isSelf) {
            if (!map || !userData.latitude || !userData.longitude) return;

            const {
                latitude,
                longitude,
                timestamp
            } = userData;
            const latLng = [latitude, longitude];
            const isStale = (Date.now() - timestamp) > USER_INACTIVITY_THRESHOLD;

            let markerColor = isSelf ? 'blue' : (isStale ? 'red' : 'green');
            // Custom icon for markers
            const customIcon = L.divIcon({
                className: 'custom-user-marker',
                html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5);"></div><div class="user-marker-label">${username}</div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6], // Center of the circle
                popupAnchor: [0, -6]
            });

            if (userMarkers[username]) {
                userMarkers[username].setLatLng(latLng);
                // Update icon if status changes (e.g. stale status might change color)
                userMarkers[username].setIcon(customIcon);
            } else {
                userMarkers[username] = L.marker(latLng, {
                    icon: customIcon
                }).addTo(map);
                // userMarkers[username].bindPopup(`<b>${username}</b><br>Last seen: ${timeAgo(timestamp)}`).openPopup();
            }

            // If it's not the current user, draw a line and calculate distance
            if (!isSelf && currentUser && userMarkers[currentUser]) {
                const currentUserLatLng = userMarkers[currentUser].getLatLng();
                const distance = getDistance(currentUserLatLng.lat, currentUserLatLng.lng, latitude, longitude);

                const polylinePoints = [
                    [currentUserLatLng.lat, currentUserLatLng.lng],
                    latLng
                ];

                if (userPolylines[username]) {
                    userPolylines[username].setLatLngs(polylinePoints);
                } else {
                    userPolylines[username] = L.polyline(polylinePoints, {
                        color: 'grey',
                        weight: 2,
                        dashArray: '5, 5'
                    }).addTo(map);
                }
                // Update popup or a separate label for distance if needed
                userMarkers[username].setTooltipContent(`<b>${username}</b><br>${distance.toFixed(2)} km away<br>Last seen: ${timeAgo(timestamp)}`, {
                    permanent: false,
                    direction: 'top'
                });
                if (!userMarkers[username].isTooltipOpen()) {
                    userMarkers[username].openTooltip();
                }
            } else if (isSelf) {
                userMarkers[username].setTooltipContent(`<b>${username} (You)</b><br>Last seen: ${timeAgo(timestamp)}`, {
                    permanent: false,
                    direction: 'top'
                });
                if (!userMarkers[username].isTooltipOpen()) {
                    userMarkers[username].openTooltip();
                }
            }
        }

        // --- UI FUNCTIONS ---

        /**
         * Updates the list of users in the sidebar.
         */
        function updateUserListGUI(locationsData) {
            if (!currentUser || !userMarkers[currentUser]) {
                userListEl.innerHTML = '<li>Waiting for your location...</li>';
                return;
            }

            userListEl.innerHTML = ''; // Clear existing list
            const currentUserLatLng = userMarkers[currentUser].getLatLng();
            let usersArray = [];

            if (locationsData) {
                Object.keys(locationsData).forEach(username => {
                    const userData = locationsData[username];
                    if (username === currentUser) return; // Don't list self in "other users"

                    const isStale = (Date.now() - userData.timestamp) > USER_INACTIVITY_THRESHOLD;
                    if (isStale) return; // Don't list stale users who should have been removed

                    const distance = getDistance(currentUserLatLng.lat, currentUserLatLng.lng, userData.latitude, userData.longitude);
                    usersArray.push({
                        username: username,
                        distance: distance, // from current user
                        timestamp: userData.timestamp,
                        status: 'active', // Assuming active if not stale
                        latitude: userData.latitude,
                        longitude: userData.longitude
                    });
                });
            }

            // Sort users by proximity
            usersArray.sort((a, b) => a.distance - b.distance);

            if (usersArray.length === 0) {
                userListEl.innerHTML = '<li>No other users online or nearby.</li>';
            } else {
                usersArray.forEach(user => {
                    const listItem = document.createElement('li');

                    const itemHeaderDiv = document.createElement('div');
                    itemHeaderDiv.className = 'user-list-item-header';

                    const statusSpan = document.createElement('span');
                    statusSpan.className = `user-status status-${user.status}`;

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'user-name';
                    nameSpan.textContent = user.username;

                    const distanceSpan = document.createElement('span');
                    distanceSpan.className = 'user-distance';
                    distanceSpan.textContent = `(${user.distance.toFixed(1)} km)`;

                    itemHeaderDiv.appendChild(statusSpan);
                    itemHeaderDiv.appendChild(nameSpan);
                    itemHeaderDiv.appendChild(distanceSpan);

                    const detailsSpan = document.createElement('span');
                    detailsSpan.className = 'user-details';
                    detailsSpan.textContent = `Updated: ${timeAgo(user.timestamp)}`;

                    const latLngSpan = document.createElement('span');
                    latLngSpan.className = 'user-latlng';
                    latLngSpan.textContent = `Lat: ${user.latitude.toFixed(4)}, Lng: ${user.longitude.toFixed(4)}`;

                    listItem.appendChild(itemHeaderDiv);
                    listItem.appendChild(detailsSpan);
                    listItem.appendChild(latLngSpan);

                    listItem.dataset.username = user.username; // Store username for easy access on click
                    listItem.addEventListener('click', () => handleUserListItemClick(user.username, listItem));

                    // Check if this user is selected and apply class
                    if (selectedPairForDistance.includes(user.username)) {
                        listItem.classList.add('selected');
                    }

                    userListEl.appendChild(listItem);
                });
            }
        }

        function handleUserListItemClick(username, listItemElement) {
            const index = selectedPairForDistance.indexOf(username);
            if (index > -1) { // User is already selected, deselect them
                selectedPairForDistance.splice(index, 1);
                listItemElement.classList.remove('selected');
            } else { // User is not selected
                if (selectedPairForDistance.length < 2) {
                    selectedPairForDistance.push(username);
                    listItemElement.classList.add('selected');
                } else {
                    // If 2 are selected, and a 3rd (different) one is clicked, replace the first selected.
                    const firstSelectedUsername = selectedPairForDistance[0];
                    // Deselect the first one visually
                    const firstSelectedLi = userListEl.querySelector(`li[data-username="${firstSelectedUsername}"]`);
                    if (firstSelectedLi) {
                        firstSelectedLi.classList.remove('selected');
                    }
                    selectedPairForDistance.shift(); // Remove the first selected user
                    selectedPairForDistance.push(username); // Add the new user
                    listItemElement.classList.add('selected');
                }
            }
            updateDistanceToolUI();
        }

        function updateDistanceToolUI() {
            selectedUser1NameEl.textContent = selectedPairForDistance[0] || 'None';
            selectedUser2NameEl.textContent = selectedPairForDistance[1] || 'None';

            if (selectedPairForDistance.length === 2) {
                calculateDistanceBtn.disabled = false;
            } else {
                calculateDistanceBtn.disabled = true;
                distanceResultEl.textContent = ''; // Clear previous result
            }
        }

        function calculateDistanceBetweenSelected() {
            if (selectedPairForDistance.length !== 2) return;

            const user1Name = selectedPairForDistance[0];
            const user2Name = selectedPairForDistance[1];

            const user1Data = allUsersData[user1Name];
            const user2Data = allUsersData[user2Name];

            if (user1Data && typeof user1Data.latitude === 'number' && typeof user1Data.longitude === 'number' &&
                user2Data && typeof user2Data.latitude === 'number' && typeof user2Data.longitude === 'number') {

                const dist = getDistance(user1Data.latitude, user1Data.longitude, user2Data.latitude, user2Data.longitude);
                distanceResultEl.textContent = `Distance: ${dist.toFixed(2)} km`;
            } else {
                distanceResultEl.textContent = "Error: Location data missing for one or both users.";
                console.error("Missing location data for distance calculation:", user1Name, user1Data, user2Name, user2Data);
            }
        }


        // --- GEOLOCATION FUNCTIONS ---

        /**
         * Starts watching the user's geolocation.
         */
        function startGeolocationWatch() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                connectionStatusEl.textContent = "Geolocation not supported.";
                return;
            }

            connectionStatusEl.textContent = "Getting location...";

            const geoOptions = {
                enableHighAccuracy: true,
                timeout: 10000, // 10 seconds
                maximumAge: 0 // Don't use a cached position
            };

            function success(position) {
                const {
                    latitude,
                    longitude
                } = position.coords;

                if (!map) { // Initialize map on first successful location
                    initMap(latitude, longitude);
                }

                // Update current user's marker and Firebase
                updateUserLocation(latitude, longitude);
                updateUserOnMap(currentUser, {
                    latitude,
                    longitude,
                    timestamp: Date.now()
                }, true);

                // Update Latitude and Longitude display
                if (currentLatitudeEl && currentLongitudeEl) {
                    currentLatitudeEl.textContent = latitude.toFixed(5);
                    currentLongitudeEl.textContent = longitude.toFixed(5);
                }

                // Center map on user if it's the first time or if a setting is enabled
                // For now, let's just ensure the user is visible
                if (map && userMarkers[currentUser]) {
                    // map.setView([latitude, longitude], map.getZoom()); // Option: always center
                }
                connectionStatusEl.textContent = "Online";
            }

            function error(err) {
                console.warn(`ERROR(${err.code}): ${err.message}`);
                connectionStatusEl.textContent = `Error: ${err.message}`;
                // If map hasn't been initialized yet (e.g. first location failed), try with a default
                if (!map) {
                    initMap(0, 0); // Default to (0,0) or a known island center
                    alert("Could not get your location. Map initialized at a default spot. Try refreshing or enabling location services.");
                }
            }

            // Initial immediate fetch
            navigator.geolocation.getCurrentPosition(success, error, geoOptions);

            // Watch for continuous updates
            navigator.geolocation.watchPosition(success, error, geoOptions);

            // Fallback/manual update interval (in case watchPosition is slow or stalls)
            // This is less critical if watchPosition works well, but good as a backup.
            // The prompt asked for updates "as fast as possible without throttling" via watchPosition.
            // The manual refresh button serves the "GPS stalling" case.
            // An additional interval might be redundant if watchPosition is effective.
            // setInterval(() => {
            //     navigator.geolocation.getCurrentPosition(success, error, geoOptions);
            // }, LOCATION_UPDATE_INTERVAL * 5); // e.g., every 5 seconds as a fallback
        }

        /**
         * Manually triggers a location update.
         */
        function manualRefreshLocation() {
            if (!currentUser || !navigator.geolocation) {
                alert("Cannot refresh: User not logged in or geolocation not available.");
                return;
            }
            connectionStatusEl.textContent = "Refreshing location...";
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const {
                        latitude,
                        longitude
                    } = position.coords;
                    updateUserLocation(latitude, longitude);
                    updateUserOnMap(currentUser, {
                        latitude,
                        longitude,
                        timestamp: Date.now()
                    }, true);
                    // Update Latitude and Longitude display
                    if (currentLatitudeEl && currentLongitudeEl) {
                        currentLatitudeEl.textContent = latitude.toFixed(5);
                        currentLongitudeEl.textContent = longitude.toFixed(5);
                    }
                    if (map) map.setView([latitude, longitude], map.getZoom()); // Center on refresh
                    connectionStatusEl.textContent = "Location refreshed!";
                    setTimeout(() => {
                        if (connectionStatusEl.textContent === "Location refreshed!") {
                            connectionStatusEl.textContent = "Online";
                        }
                    }, 2000);
                },
                (err) => {
                    console.warn(`Manual Refresh ERROR(${err.code}): ${err.message}`);
                    connectionStatusEl.textContent = `Refresh failed: ${err.message}`;
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }


        // --- INITIALIZATION ---

        /**
         * Initializes the application.
         */
        function initApp() {
            // 1. Get username
            let storedUser = localStorage.getItem('trackFriendUsername');
            if (storedUser) {
                currentUser = storedUser;
            } else {
                currentUser = prompt("Please enter your username for tracking:", `User${Math.floor(Math.random() * 1000)}`);
                if (!currentUser || currentUser.trim() === "") {
                    currentUser = `Guest${Math.floor(Math.random() * 1000)}`;
                }
                localStorage.setItem('trackFriendUsername', currentUser);
            }
            currentUsernameEl.textContent = currentUser;

            // 2. Start geolocation and Firebase listeners
            startGeolocationWatch();
            listenForLocationUpdates();

            // 3. Setup UI interactions
            refreshButton.addEventListener('click', manualRefreshLocation);
            calculateDistanceBtn.addEventListener('click', calculateDistanceBetweenSelected);

            // Handle browser unload for cleanup (onDisconnect is primary, this is fallback)
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    // Firebase onDisconnect should handle this, but as a safeguard:
                    // database.ref(`locations/${currentUser}`).remove(); // This might not execute reliably
                }
            });

            // Initial UI update for user list (will be empty at first)
            updateUserListGUI(null);
            updateDistanceToolUI(); // Initialize distance tool UI
        }

        // Start the app when the DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>